<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>彩票网</title>
    <link rel="stylesheet" href="../../css/bootstrap.css">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" type="text/css" href="../../css/cropper.min.css">
    <link rel="stylesheet" type="text/css" href="../../css/sitelogo.css">
    <link rel="stylesheet" type="text/css" href="../../lib/mui/css/mui.css">
    <script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../../lib/cutimg/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../lib/cutimg/cropper.js"></script>
    <script type="text/javascript" src="../../lib/cutimg/sitelogo11.js"></script>
    <script type="text/javascript" src="../../lib/cutimg/html2canvas.js"></script>
    <script src="../../lib/artTemplate/template-native.js"></script>
    <script src="../../lib/mui/js/mui.js"></script>

    <style>
        * {
            font-size: .28rem;
        }

        .list {
            border-bottom: 1px solid #dadada;
            background: #ffffff;
            padding: .1rem 0;
            overflow: hidden;
            position: relative;
        }

        .list.mid {
            padding: .2rem 0;
        }

        .big {
            height: 1.4rem;
        }

        .small {
            height: .9rem;
        }

        .list .left {
            float: left;
            color: #333333;
            width: 25%;
            padding-left: 0.2rem;
        }

        .list .right {
            float: left;
            width: 40%;
            padding-right: 0.2rem;
        }
        
        .list .onetip{
            width: 35%;
            float: left;
            text-align: right;
            height: 0.7rem;
            line-height: .7rem;
            padding-right: 0.2rem;
            color: #d3233c;
            font-size: .22rem;
        }
        .list .twotip{
            width: 35%;
            float: left;
            text-align: right;
            height: 0.7rem;
            line-height: 0.35rem;
            padding-right: 0.2rem;
            color: #d3233c;
            font-size: .22rem;
        }
        .list input.right {
            font-size: .28rem;
        }

        .big .left,
        .big .right {
            height: 1.2rem;
            line-height: 1.2rem;
        }

        .small .left,
        .small .right {
            height: .7rem;
            line-height: .7rem;
        }

        .mid .left {
            height: .8rem;
            line-height: .8rem;
        }

        .mid .right {
            height: .8rem;
            line-height: .4rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }

        .big .headimg {
            display: inline-block;
            width: 1.2rem;
            height: 1.2rem;
            border-radius: 0.05rem;
            background: #e5e5e5;
        }

        .bt {
            display: block;
            border-radius: .05rem;
            width: 5.3rem;
            height: .8rem;
            line-height: 0.8rem;
            background: #dddddd;
            text-align: center;
            font-size: 0.32rem;
            color: #ffffff;
            margin: .3rem auto;
        }
        
        .bt.ok{
            background: #d3233c;
        }
        .identy_code {
            width: 2rem;
            height: .7rem;
            line-height: .7rem;
            text-align: center;
            color: #fff;
            font-size: .28rem;
            background: #d3233c;
            border-radius: 0.1rem;
            position: absolute;
            top: 0;
            bottom: 0;
            right: .2rem;
            margin: auto;
        }

        .login {
            text-align: center;
            font-size: .28rem;
        }

        .login a {
            color: #333;
        }

        .login a span {
            color: #d3233c;
        }

        #phonecode {
            padding-right: 2.5rem;
        }

        select {
            border: none;
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
            background: #ffffff;
            padding-right: 14px;
            font-size: .28rem;
        }

        /*清除ie的默认选择框样式清除，隐藏下拉箭头*/
        select::-ms-expand {
            display: none;
        }

        input::-webkit-input-placeholder,
        textarea::-webkit-input-placeholder {
            color: #999999;
        }

        input:-moz-placeholder,
        textarea:-moz-placeholder {
            color: #999999;
        }

        input::-moz-placeholder,
        textarea::-moz-placeholder {
            color: #999999;
        }

        input:-ms-input-placeholder,
        textarea:-ms-input-placeholder {
            color: #999999;
        }
        #btn3{
            background: #d3233c;
        }
        /* 滑动验证样式 */

        /* .stage {
            position: relative;
            padding: 0 .3rem;
            height: .9rem;
            margin: .3rem 0;
        }

        .slider {
            position: absolute;
            height:.9rem;
            box-shadow: 0 0 3px #999;
            background-color: #ddd;
            left: .3rem;
            right: .3rem;
            text-align: center;
        }

        .label {
            background: -webkit-gradient(linear, left top, right top, color-stop(0, #4d4d4d), color-stop(.4, #4d4d4d), color-stop(.5, white), color-stop(.6, #4d4d4d), color-stop(1, #4d4d4d));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-animation: slidetounlock 3s infinite;
            -webkit-text-size-adjust: none;
            line-height: .9rem;
            height:.9rem;
            text-align: center;
            font-size: .28rem;
            width: 100%;
            color: #aaa;
        }

        @keyframes slidetounlock {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: 200px 0;
            }
        }

        @-webkit-keyframes slidetounlock {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: 200px 0;
            }
        }

        .button {
            position: absolute;
            left: 0;
            top: 0;
            width: .9rem;
            height: .9rem;
            background-color: #fff;
            transition: left 0s;
            -webkit-transition: left 0s;
        }

        .button-on {
            position: absolute;
            left: 0;
            top: 0;
            width: .9rem;
            height:.9rem;
            background-color: #fff;
            transition: left 1s;
            -webkit-transition: left .5s;
        }

        .track {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            overflow: hidden;
            transition: width 0s;
            -webkit-transition: width 0s;
        }

        .track-on {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            overflow: hidden;
            transition: width 1s;
            -webkit-transition: width .5s;
        }

        .icon {
            width: .9rem;
            height: .9rem;
            font-family: sans-serif;
            position: relative;
        }

        .icon:before {
            content: '>>';
            color: #ccc;
            line-height: .9rem;
        }

        .spinner {
            width: .64rem;
            height: .64rem;
            background: url('../../images/ok.png') no-repeat;
            position: relative;
            top: .13rem;
            left: .13rem;
            display: none;
        }

        @-webkit-keyframes bouncedelay {
            0%,
            80%,
            100% {
                -webkit-transform: scale(0.0)
            }
            40% {
                -webkit-transform: scale(1.0)
            }
        }

        @keyframes bouncedelay {
            0%,
            80%,
            100% {
                transform: scale(0.0);
                -webkit-transform: scale(0.0);
            }
            40% {
                transform: scale(1.0);
                -webkit-transform: scale(1.0);
            }
        }

        .bg-green {
            line-height:.9rem;
            height:.9rem;
            text-align: center;
            font-size: 16px;
            background-color: #78c430;
            color: #ffffff;
            font-size: .32rem;
        } */
    </style>
</head>

<body>
    <!-- 头部 start -->
    <header class="navbar-fixed-top clearfix">
        <a href="javascript:history.back(-1)" class="return fl">
            <img src="../../images/back.png">
            <span>返回</span>
        </a>
        <p class="fl">注册</p>
    </header>
    <div style="height: 0.8rem"></div>
    <!-- 头部  end -->

    <form class="personal_info clearfix">
    	<!-- <input type="hidden" id="formTokenName" name="formTokenName" value="">
    	<input type="hidden" id="formToken" name="formToken" value=""> -->
        <div class="list big" type="button" data-toggle="modal" data-target="#avatar-modal" onClick="$('input[id=avatarInput]').click();">
            <span class="left">头像</span>
            <span class="right">
                <span class="headimg"></span>
            </span>
        </div>
        <div class="list small">
            <span class="left">用户名</span>
            <input type="text" class="right" id="userName" name="memberName" placeholder="注册成功后不可修改" />
            <span class="twotip" id="nametip"></span>
        </div>
        <div class="list small">
            <span class="left">密码</span>
            <input type="text" class="right" id="loginPwd" name="loginPwd" placeholder="请设置6-18位密码" />
            <span class="twotip" id="pwdtip"></span>
        </div>
        <div class="list small">
            <span class="left">身份证号码</span>
            <input type="text" class="right" id="idcard" name="idCardNumber" placeholder="请输入身份证号码" />
            <span class="onetip" id="idcardtip"></span>
        </div>
        <div class="list small">
            <span class="left">性别</span>
            <select class="right" name="gender">
                <option value="0">男</option>
                <option value="1">女</option>
            </select>
        </div>
        <div class="list small">
            <span class="left">省</span>
            <select class="right" id="province" name="provinceCode">
                <option value="0">所在省份</option>
            </select>
        </div>
        <div class="list small">
            <span class="left">市</span>
            <select class="right" id="city" name="cityCode">
                <option value="0">所在城市</option>
            </select>
        </div>
        <div class="list small">
            <span class="left">区县</span>
            <select class="right" id="district" name="districtCode">
                <option value="0">所在区县</option>
            </select>
        </div>
        <div class="list small">
            <span class="left">手机号码</span>
            <input type="number" class="right" name="mobile" id="phone" placeholder="请输入手机号码" />
            <span class="onetip" id="phonetip"></span>
        </div>
        <!-- <div class="stage">
            <div class="slider" id="slider">
                <div class="label">向右滑动验证</div>
                <div class="track-on" id="track" style="width: 0px;">
                    <div class="bg-green" id="ok"></div>
                </div>
                <div class="button-on" id="btn" style="left: 0px;">
                    <div class="icon" id="icon"></div>
                    <div class="spinner" id="spinner"></div>
                </div>
            </div>
        </div> -->
        <button id="btn3" class="bt">提交</button>
    </form>
    <div class="login">
        <a href="user_login.html">已有账号？立马
            <span>登录&gt;</span>
        </a>
    </div>

    <!-- 弹出裁剪框 start-->
    <div class="modal fade" id="avatar-modal" aria-hidden="true" aria-labelledby="avatar-modal-label" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form class="avatar-form" action="upload-logo.php" enctype="multipart/form-data" method="post">
                    <button class="avatar-save " type="button" data-dismiss="modal">确定</button>
                    <div class="modal-body">
                        <div class="avatar-body">
                            <div class="avatar-upload">
                                <input class="avatar-src" name="avatar_src" type="hidden">
                                <input class="avatar-data" name="avatar_data" type="hidden">
                                <input class="avatar-input hide" id="avatarInput" name="avatar_file" type="file">
                            </div>
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="avatar-wrapper"></div>
                                </div>
                                <div class="col-md-3 hideyulang">
                                    <div class="avatar-preview preview-lg" id="imageHead"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="loading" aria-label="Loading" role="img" tabindex="-1"></div>
    <!-- 弹出剪裁框 end -->
</body>
<script type="text/template" id="provinceList">
    <%for(var i =0; i<data.length;i++){%>
        <option value="<%=data[i].regionCode%>"><%=data[i].regionName%></option>
    <%}%>   
</script>
<script type="text/template" id="cityList">
    <%for(var i =0; i<childList.length; i++){%>
        <option value="<%=childList[i].regionCode%>"><%=childList[i].regionName%></option>
    <%}%>   
</script>
<script type="text/template" id="districtList">
    <%for(var i =0; i<childList.length; i++){%>
        <option value="<%=childList[i].regionCode%>"><%=childList[i].regionName%></option>
    <%}%>
</script>
<!-- <script src="../../lib/slider/slider.js"></script> -->
<script>
    let checkArr = [0,0,0,0]
    // 省市区联动信息
    // $.ajax({
    //     type: "GET",
    //     dataType: "json",
    //     url: "/data/region.json?provinceCode=&cityCode=&districtCode=",
    //     success: function (data) {
    //         localStorage.setItem('addressData', JSON.stringify(data));
    //     },
    //     error: function (e) {
    //         alert("地址数据请求失败！")
    //     }
    // })
    // 渲染省数据
    let addressData = JSON.parse(localStorage.getItem('addressData'))
    let detail = template('provinceList', addressData)
    $('#province').html('<option value="0">所在省份</option>' + detail)
    $('#province').on('change', function () {
        let selectRegionCode = $('#province').val()
        if (selectRegionCode != 0) {
            if (selectRegionCode == '110000') {
                $('#city').html('<option value="110000">北京市</option>')
                // alert(selectRegionCode)
            } else if (selectRegionCode == '120000') {
                $('#city').html('<option value="120000">天津市</option>')
            } else if (selectRegionCode == '310000') {
                $('#city').html('<option value="310000">上海市</option>')
            } else if (selectRegionCode == '500000') {
                $('#city').html('<option value="500000">重庆市</option>')
            } else {
                let addressData = JSON.parse(localStorage.getItem('addressData'))
                addressData.data.map((pVal) => {
                    if (selectRegionCode == pVal.regionCode) {
                        selectCity(pVal)
                    }
                })
            }
        } 

        let selectDistrictCode = $('#city').val()
        if (selectDistrictCode != 0) {
            let addressData = JSON.parse(localStorage.getItem('addressData'))
            addressData.data.map((pVal) => {
                if (selectRegionCode == pVal.regionCode) {
                    pVal.childList.map((cVal) => {
                        if (selectDistrictCode == cVal.regionCode) {
                            selectDistrict(cVal)
                        }
                    })
                }
            })
        } else {
            alert("市级还没选哦！")
            $(this).blur();
        }
    })
    // 市级选择
    $('#city').on('change', function () {
        let selectRegionCode = $('#province').val()
        let selectDistrictCode = $('#city').val()
        if (selectDistrictCode != 0) {
            let addressData = JSON.parse(localStorage.getItem('addressData'))
            addressData.data.map((pVal) => {
                if (selectRegionCode == pVal.regionCode) {
                    pVal.childList.map((cVal) => {
                        if (selectDistrictCode == cVal.regionCode) {
                            selectDistrict(cVal)
                        }
                    })
                }
            })
        } 
    })
    // 区县选择
    function selectCity(pVal) {
        let cityDetail = template('cityList', pVal)
        $('#city').html(cityDetail)
    }
    function selectDistrict(cVal) {
        let districtDetail = template('districtList', cVal)
        $('#district').html(districtDetail)
    }
    // 用户名校验
    $('body').on('blur', '#userName', function () {
        const userName = $.trim($(this).val());
        // "汉字 英文字母 数字 下划线组成，4-16位
        const userNameReg = /^[\u4E00-\u9FA5a-zA-Z0-9_]{4,16}$/;
        if (!userNameReg.test(userName)) {
            $('#nametip').html('仅允许4-16位的字符，汉字、字母、数字、下划线')
            checkArr[0] = 0
            return false;
        }else{
            checkArr[0] = 1
            $('#nametip').html('')
        }
    });
    // 密码校验
    $('body').on('blur', '#loginPwd', function () {
        const loginPwd = $.trim($(this).val());
        // 密码(以字母开头，长度在6~18之间，只能包含字母、数字和下划线)
        const loginPwdReg = /^(\w){6,18}$/;
        if (!loginPwdReg.test(loginPwd)) {
            $('#pwdtip').html('仅允许6~18位字符，可以是字母、数字和下划线')
            checkArr[1] = 0
            return false;
        }else{
            checkArr[1] = 1
            $('#pwdtip').html('')
        }
    });
    // 身份证校验
    $('body').on('blur', '#idcard', function () {
        const sId = $.trim($(this).val());
        isCardID(sId);
    });
    // 严格的身份证校验
    function isCardID(sId) {
        if (!/(^\d{15}$)|(^\d{17}(\d|X|x)$)/.test(sId)) {
            $('#idcardtip').html('身份证长度或格式错误')
            checkArr[2] = 0
            return false
        }else{
            $('#idcardtip').html('')
            checkArr[2] = 1
        }
        //身份证城市
        var aCity={11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"};
        if(!aCity[parseInt(sId.substr(0,2))]) {
            $('#idcardtip').html('你的身份证地区非法')
            checkArr[2] = 0
            return false
        }else{
            $('#idcardtip').html('')
            checkArr[2] = 1
        }

        // 出生日期验证
        var sBirthday=(sId.substr(6,4)+"-"+Number(sId.substr(10,2))+"-"+Number(sId.substr(12,2))).replace(/-/g,"/"),
            d = new Date(sBirthday)
        if(sBirthday != (d.getFullYear()+"/"+ (d.getMonth()+1) + "/" + d.getDate())) {
            $('#idcardtip').html('身份证上的出生日期非法')
            checkArr[2] = 0
            return false
        }else{
            $('#idcardtip').html('')
            checkArr[2] = 1
        }

        // 身份证号码校验
        var sum = 0,
            weights =  [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2],
            codes = "10X98765432"
        for (var i = 0; i < sId.length - 1; i++) {
            sum += sId[i] * weights[i];
        }
        var last = codes[sum % 11]; //计算出来的最后一位身份证号码
        if (sId[sId.length-1] != last) { 
            $('#idcardtip').html('你输入的身份证号非法')
            checkArr[2] = 0
            return false
        }else{
            $('#idcardtip').html('')
            checkArr[2] = 1
        }
        return true
    }
    // 电话号码校验
    $('#phone').on('blur', function () {
        const phone = $.trim(parseInt($(this).val()));
        const reg = /^1([358][0-9]|4[579]|66|7[0135678]|9[89])[0-9]{8}$/;
        if (!reg.test(phone)) {
            $('#phonetip').html('请输入正确的手机号');
            checkArr[3] = 0
            return false;
        }else{
            $('#phonetip').html('')
            checkArr[3] = 1
        }
    });
    // 增加图片
    $(".avatar-save").unbind("click").bind("click", function () {
        var img_lg = document.getElementById('imageHead');
        var canvas = document.createElement("canvas"),
            w = $('#imageHead').width(),
            h = $('#imageHead').height();
        canvas.width = w * 4;
        canvas.height = h * 4;
        canvas.style.width = w + "px";
        canvas.style.height = h + "px";
        var context = canvas.getContext("2d");
        context.scale(4, 4);
        // 截图小的显示框内的内容
        html2canvas(img_lg, {
            allowTaint: true,
            taintTest: false,
            logging: true,
            canvas: canvas,
            onrendered: function (canvas) {
                canvas.id = "mycanvas";
                //生成base64图片数据
                var dataUrl = canvas.toDataURL("image/jpeg");
                var newImg = document.createElement("img");
                newImg.src = dataUrl;
                $(".headimg").html("<img style='border-radius: 0.05rem;' src='" + newImg.src + "' alt=''>");
            }
        });
    })
    // 注册信息提交修改
    $("#btn3").click(function (e) {
        e.preventDefault()
        var provinceSlected = $('#province option:selected').val()
        var citySlected = $('#city option:selected').val()
        var districtSlected = $('#district option:selected').val()
        if(checkArr.indexOf(0) != -1 || provinceSlected == '0' || citySlected == '0' || districtSlected == '0') {
            alert('信息填写有误！校验失败！')
            return
        }  
        var formArray = $(".personal_info").serializeArray();
    	var dataObj = {};
    	for(var i=0;i<formArray.length;i++){
    		dataObj[formArray[i].name]=formArray[i].value;
        }
        dataObj.headImages = $(".headimg img").attr("src");
        $.ajax({
            type: "POST",
            url: "/member/register.json",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            data: dataObj,
            success: function (data) {
                if(data.code=="00000"){
                    let btnArr = ['确定']
                    mui.confirm('注册成功', '提示', btnArr, function(e){
                        if(e.index == 0) {
                          location.href='./user_login.html' 
                        }
                    })
                    
                }else{
                    mui.alert(data.msg);
                }
            },
            error: function (e) {
            	mui.alert("数据提交失败！")
            }
        });
    });
    
   /*  $(document).ready(function(){
    	$.ajax({
            type: "GET",
            url: "/produceToken.json",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            data: "",
            success: function (data) {
                console.log(data)
                if(data.code=="00000"){
                    $("#formTokenName").val(data.data.formTokenName);
                    $("#formToken").val(data.data.formToken);
                }
            },
            error: function (e) {
                alert("产生token失败！")
            }
        });
    }); */
    
</script>
</html>